# Тестовое задание - PHP разработчик

### Задание 1 - Обработка курсов валют Национального Банка Республики Казахстан

Необходимо реализовать сервис со следующим функционалом на языке PHP (не ниже версии 8.2) c использованием фреймворка Laravel. В качестве базы данных может использоваться MySQL/PostgreSQL.

В базе данных **testcase_db** должна быть таблица _currency_ c колонками:

 1. **id** — первичный ключ;
 2. **code** — код валюты;
 3. **name** — название валюты;
 4. **rate** — курс валюты к тенге;
 5. **date** — дата получения курса.

#### Задача 1 - Загрузка данных из первоисточника

Должна быть консольная команда (с возможностью запуска через cron) для обновления данных в таблице currency. Данные по курсам валют можно взять отсюда: [https://nationalbank.kz/rss/rates_all.xml?switch=russian](https://nationalbank.kz/rss/rates_all.xml?switch=russian)

#### Задача 2 - Реализация REST API сервисов

Необходимо реализовать 2 REST API метода:

 - GET /currencies — должен возвращать список курсов валют с возможностью пагинации на текущую дату (в качестве опционального параметра может быть передана произвольная дата в виде параметра _date_);
 - GET /currencies/:code  — должен возвращать курс валюты для переданного кода валюты (code) на текущую дату (в качестве опционального параметра может быть передана произвольная дата в виде параметра _date_).

Для возвращаемых результатов должны возвращаться корректные статусы HTTP-ответов:

 - **200** — данные найдены;
 - **401** — токен не предоставлен;
 - **403** — предоставлен некорректный токен;
 - **404** — данные (на текущую дату) не найдены.

API должно быть защищено Bearer авторизацией. Токен авторизации может быть жестко зашит в саму систему. 

### Задание 2 - Обработка классификатора административно-территориальных объектов (КАТО)

Необходимо реализовать алгоритм (в виде консольной команды) и сервис со следующим функционалом на языке PHP (не ниже версии 8.2) c использованием фреймворка Laravel. В качестве базы данных может использоваться MySQL/PostgreSQL.

В базе данных **testcase_db** должна быть таблица kato c колонками:

 1. **te** — первичный ключ - уникальный код объекта;
 2. **ab** — первый уровень - первые 2 символа от кода te;
 3. **cd** — второй уровень - вторые 2 символа от кода te;
 4. **ef** - третий уровень - третьи 2 символа от кода te;
 5. **hij** - четверый уровень - оставшиеся 3 символа от кода te;
 6. **k** - принадлежность объекта;
 6. **parent** - родительский элемент в иерархии*;
 7. **level** - уровень (начиная с 2)*;
 8. **name_ru** — наименование объекта на русском языке;
 9. **name_kz** - наименование объекта на казахском языке;
 10. **fullname_ru** - полное наименование (путь) объекта на русском языке*;
 11. **fullname_kz** - полное наименование (путь) объекта на казахском языке*;
 12. **start_date** - дата начала появления объекта в справочнике*;
 13. **end_date** - дата исключения объекта из справочника*;
 14. **created_at** - дата и время создания записи;
 15. **updated_at** - дата и время изменения записи.
 
Структура справочника КАТО НК РК 11-2009 описана на сайте первоисточника - Агенства по статистике Республики Казахстан в разделе [Классификаторы](https://stat.gov.kz/api/getFile/?docId=ESTAT313004). Описание на момент публикации доступно по [ссылке](https://stat.gov.kz/api/getFile/?docId=ESTAT313004)

Должна быть реализована консольная команда (с возможностью запуска через cron) для первоначальной загрузки и последующего обновления данных в таблице kato. Актуальный справочник можно взять [здесь](https://stat.gov.kz/api/getFile/?docId=ESTAT401472)

#### Задача 1 - Загрузка первоначальных данных

В предоставляемых данных (excel) уже имеются практически все данные, не хватает лишь 6 столбцов:

1. parent - прямой родитель (код te) текущей записи, либо NULL если запись не имеет родителя;
2. level - уровень записи - зависит от количества родителей (2 для записи верхнего уровня - города республиканского значения и области);
3. fullname_ru - полная иерархия наименований (name_ru родителей + текущее наименование), начиная с верхнего уровня через запятую на русском языке;
4. fullname_kz - полная иерархия наименований (name_kz родителей + текущеее наименование), начиная с верхнего уровня через запятую на казахском языке;
5. start_date - заполняется автоматически текущей датой при наличии записи в справочнике;
6. end_date - заполняется автоматически при обновлении данных в задаче 2 при отсутствии записи в обновленном справчнике (NULL - если запись активна).

##### Примеры

*г. Астана (710000000)* находится на 2 уровне (область или город республиканского значения) и не имеет родителя. Структура данных для этой записи будет выглядеть следующим образом:

| Поле  | Значение |
| ------------- | ------------- |
| te  | 710000000  |
| parent | null |
| level | 2 |
| fullname_ru | г.Астана |
| fullname_kz | 	Астана қ. |

*Зимовка Балгабек-Аксай (353655102)* находится на 6 (последнем) уровне. Структура данных для этой записи будет выглядеть следующим образом:

| Поле  | Значение |
| ------------- | ------------- |
| te  | 353655102  |
| parent | 353655100 |
| level | 6 |
| fullname_ru | Карагандинская область, Актогайский район, Hуркенский с.о., с.Hуркен, зимовка Балгабек-Аксай |
| fullname_kz | 	Қарағанды облысы, Ақтоғай ауданы, Нүркен а.о., Нүркен а., Балғабек-Ақсай қыстауы |

Необходимо обработать все записи в предоставляемых excel-документах исходного справочника и сохранить их в таблицу kato c заполнением недостающих полей. В качестве параметра скрипту (команде) необходимо указать путь к файла (или директории с файлами) для загрузки и обработки. Дополнительные параметры и опции на усмотрение разработчика. Допускается повторная обработках записей уже после сохранения их в таблице базы данных.

Данные для первоначальной загрузки (2019 год) находятся [здесь](data/kato/2019/katonew1.xls) и [здесь](data/kato/2019/katonew2.xls).

#### Задача 2 - Загрузка измененных данных (обновление)

При получении новой версии справочника появляется вопрос актуализации данных в существующем справочнике, а именно:

1. Создание новых записей;
2. Исключение существующих записей (проставление даты окончания);
3. Обновление существующих записей - наименование, уровень иерархии, родитель и тд.

Необходимо обработать все записи (новые, изменненые, отсутствующие) в предоставляемых excel-документах обновленного справочника и сохранить их в таблицу kato. В качестве параметра скрипту (команде) необходимо указать путь к файла (или директории с файлами) для загрузки и обработки. Дополнительные параметры и опции на усмотрение разработчика. Допускается повторная обработках записей уже после сохранения их в таблице базы данных.

Файлы для загрузки обновленных данных (2021 год) находятся [здесь](data/kato/2021/katonew1.xls) и [здесь](data/kato/2021/katonew1.xls), а так же приведены по ссылкам выше на сайте Агенства по статистике.

#### Задача 3 - Реализация REST API сервисов

Необходимо реализовать 3 REST API метода:

 - GET /kato — должен возвращать список активных объектов в справочнике с возможностью пагинации;
 - GET /kato/search — должен возвращать список активных объектов в справочнике по предоставленном запросу (параметр _query_).
 - GET /kato/tree/:te - должен возвращать список активных прямых дочерних объектов (на уровень ниже искомого объекта) в справочнике по предоставленном запросу (параметр _te_) - либо пустой массив при их отсутствии.

Для возвращаемых результатов должны возвращаться корректные статусы HTTP-ответов:

 - **200** — данные найдены;
 - **401** — токен не предоставлен;
 - **403** — предоставлен некорректный токен;
 - **404** — данные не найдены.

API должно быть защищено Bearer авторизацией. Токен авторизации может быть жестко зашит в саму систему.

## Требования

- Код должен быть документирован в виде указания корректных phpDoc-аннотаций к написанным классам и методам;
- Обработка входных параметров должна происходить предоставляемыми во фреймворк средствами и исключать возможность SQL-инъекций;
- Для создания таблиц и/или изменения их структуру должен использоваться предоставляемый фреймворком механизм миграций.

## Результаты

Для выполнения задания (заданий) необходимо создать форк данного репозитория, и все требуемые исходные коды залить в собственный склонированный репозиторий. В файле Readme.md(Readme.md) описать логику и структуру приложения (кода). При необходимости предоставить дополнительные комментарии и пояснения. Плюсом будет сохранение и ведение полной истории коммитов с указанием комментариев.
